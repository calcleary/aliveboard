<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aliveboard</title>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap");

    :root {
      color-scheme: light;
      --bg: #f6f5f1;
      --panel: #ffffff;
      --ink: #141414;
      --muted: #6a6a6a;
      --line: #e7e3da;
      --accent: #0b5fff;
      --top: #fff3c4;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Space Grotesk", system-ui, -apple-system, sans-serif;
      background:
        radial-gradient(1000px 500px at 0% -10%, #ffffff 0%, transparent 60%),
        radial-gradient(900px 450px at 100% -20%, #eef2ff 0%, transparent 55%),
        var(--bg);
      color: var(--ink);
    }
    header {
      max-width: 1000px;
      margin: 0 auto;
      padding: 40px 20px 20px;
      display: grid;
      gap: 8px;
    }
    h1 {
      margin: 0;
      font-size: clamp(28px, 4vw, 44px);
      letter-spacing: -0.4px;
      cursor: pointer;
    }
    .sub {
      margin: 0;
      color: var(--muted);
      font-size: 16px;
    }
    main {
      max-width: 1000px;
      margin: 0 auto;
      padding: 0 20px 50px;
      display: grid;
      gap: 18px;
    }
    .panel {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 16px;
      display: grid;
      gap: 14px;
    }
    .row {
      display: grid;
      grid-template-columns: 1.1fr 1fr;
      gap: 16px;
    }
    @media (max-width: 840px) {
      .row { grid-template-columns: 1fr; }
    }
    .leaderboard {
      display: grid;
      gap: 8px;
    }
    .entry {
      display: grid;
      grid-template-columns: 60px 1fr 80px;
      gap: 10px;
      align-items: center;
      padding: 10px 12px;
      border: 1px solid var(--line);
      border-radius: 12px;
      background: #fbfaf7;
      animation: rise 240ms ease;
      cursor: pointer;
      transition: background 0.2s ease, border-color 0.2s ease;
    }
    .entry:hover {
      background: #f6f4ee;
      border-color: #ddd7cc;
    }
    .entry.top {
      background: var(--top);
      border-color: #e7d7a4;
    }
    .rank {
      display: grid;
      gap: 2px;
      font-weight: 600;
      color: var(--accent);
    }
    .trend {
      font-size: 12px;
      color: var(--muted);
    }
    .trend.up { color: #0f7a3b; }
    .trend.down { color: #b42318; }
    .name {
      font-weight: 600;
    }
    .age {
      text-align: right;
      font-weight: 600;
    }
    .meta {
      color: var(--muted);
      font-size: 13px;
    }
    form {
      display: grid;
      gap: 10px;
    }
    label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.6px;
      color: var(--muted);
    }
    input, textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--line);
      border-radius: 12px;
      font-size: 14px;
      background: #fff;
      font-family: inherit;
    }
    textarea {
      min-height: 70px;
      resize: vertical;
    }
    button {
      padding: 10px 12px;
      border: 1px solid var(--line);
      border-radius: 12px;
      background: #f0efe9;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    button:hover { background: #e8e6df; }
    .hint {
      font-size: 12px;
      color: var(--muted);
    }
    .stats {
      display: flex;
      gap: 12px;
      color: var(--muted);
      font-size: 13px;
      flex-wrap: wrap;
    }
    .badge {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid var(--line);
      background: #fff;
      color: var(--muted);
    }
    .view {
      display: none;
    }
    .view.active {
      display: block;
    }
    .profile {
      display: grid;
      gap: 12px;
    }
    .profile h2 {
      margin: 0;
    }
    .profile-card {
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 16px;
      background: #fbfaf7;
      display: grid;
      gap: 8px;
    }
    .profile-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .back {
      border: 1px solid var(--line);
      background: #f1efe8;
      border-radius: 10px;
      padding: 6px 10px;
      font-size: 12px;
      cursor: pointer;
      width: fit-content;
    }
    .error {
      color: #b42318;
      font-size: 13px;
    }
    @keyframes rise {
      from { transform: translateY(6px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
  </style>
</head>
<body>
  <header>
    <h1 id="home-link">Aliveboard</h1>
    <p class="sub">A minimalist leaderboard where people rank by age.</p>
  </header>

  <main>
    <div class="row view active" id="home-view">
      <section class="panel">
        <h2>Leaderboard</h2>
        <div class="stats" id="stats"></div>
        <div class="leaderboard" id="leaderboard"></div>
        <div class="error" id="load-error"></div>
      </section>

      <section class="panel">
        <h2>Sign Up</h2>
        <form id="signup">
          <div>
            <label for="name">Name</label>
            <input id="name" placeholder="Your name" required />
          </div>
          <div>
            <label for="age">Age</label>
            <input id="age" type="number" inputmode="numeric" min="1" max="120" placeholder="Years" required />
          </div>
          <div>
            <label for="location">Location</label>
            <input id="location" placeholder="City, Country" />
          </div>
          <div>
            <label for="bio">Bio</label>
            <textarea id="bio" placeholder="A short line about you"></textarea>
          </div>
          <button type="submit">Join the board</button>
          <div class="hint">Entries are public and stored in Aliveboard.</div>
        </form>
      </section>
    </div>

    <section class="panel view" id="profile-view">
      <button class="back" id="back-home">Back to leaderboard</button>
      <div class="profile">
        <h2 id="profile-name"></h2>
        <div class="profile-card" id="profile-card">
          <div class="meta" id="profile-meta"></div>
          <div class="name" id="profile-rank"></div>
          <div class="age" id="profile-age"></div>
          <div class="meta" id="profile-location"></div>
          <div id="profile-bio"></div>
        </div>
        <div class="profile-actions">
          <button id="download-card">Download rank card</button>
          <button id="share-profile">Share profile link</button>
        </div>
      </div>
    </section>
  </main>

  <canvas id="card-canvas" width="900" height="500" style="display:none"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://gbxhbbbozzrnaxnrilmy.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdieGhiYmJvenpybmF4bnJpbG15Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3MzcwMzIsImV4cCI6MjA4NjMxMzAzMn0.Mih-TIFasRrdmnWMoFWXreiuhVuybjKwX5h3VYyBc8o";

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const rankKey = "aliveboard.rank.v1";

    let members = [];

    async function fetchMembers() {
      const { data, error } = await supabase
        .from("members")
        .select("id, name, age, location, bio, created_at")
        .order("age", { ascending: false })
        .order("created_at", { ascending: true });

      if (error) {
        document.getElementById("load-error").textContent = "Could not load leaderboard. Please try again later.";
        console.error(error);
        return;
      }
      members = data || [];
      render();
    }

    function render() {
      const board = document.getElementById("leaderboard");
      board.innerHTML = "";

      const prevRanks = loadRanks();
      const newRanks = {};

      members.forEach((entry, index) => {
        const rank = index + 1;
        newRanks[entry.id] = rank;

        const item = document.createElement("div");
        item.className = "entry";
        if (rank <= 10) item.classList.add("top");
        const trend = getTrend(prevRanks[entry.id], rank);

        item.innerHTML = `
          <div class="rank">
            <div>#${rank}</div>
            <div class="trend ${trend.className}">${trend.text}</div>
          </div>
          <div>
            <div class="name">${escapeHtml(entry.name)}</div>
            <div class="meta">Joined ${formatDate(entry.created_at)}</div>
          </div>
          <div class="age">${entry.age}</div>
        `;
        item.addEventListener("click", () => openProfile(entry));
        board.appendChild(item);
      });

      const stats = document.getElementById("stats");
      stats.innerHTML = "";
      stats.appendChild(statBadge(`${members.length} members`));
      if (members.length) {
        const ages = members.map((m) => m.age);
        stats.appendChild(statBadge(`Oldest ${Math.max(...ages)}`));
        stats.appendChild(statBadge(`Youngest ${Math.min(...ages)}`));
      }
      stats.appendChild(statBadge("Top 10 highlighted"));

      saveRanks(newRanks);
    }

    function statBadge(text) {
      const span = document.createElement("span");
      span.className = "badge";
      span.textContent = text;
      return span;
    }

    function getTrend(previous, current) {
      if (!previous) return { text: "•", className: "" };
      const delta = previous - current;
      if (delta > 0) return { text: `▲ +${delta}`, className: "up" };
      if (delta < 0) return { text: `▼ ${delta}`, className: "down" };
      return { text: "•", className: "" };
    }

    function loadRanks() {
      try {
        return JSON.parse(localStorage.getItem(rankKey)) || {};
      } catch {
        return {};
      }
    }

    function saveRanks(ranks) {
      localStorage.setItem(rankKey, JSON.stringify(ranks));
    }

    function formatDate(value) {
      if (!value) return "today";
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) return "today";
      return date.toLocaleDateString(undefined, { month: "short", day: "numeric", year: "numeric" });
    }

    function escapeHtml(value) {
      return String(value).replace(/[&<>"']/g, (ch) => ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#39;"
      }[ch]));
    }

    function openProfile(member) {
      document.getElementById("home-view").classList.remove("active");
      document.getElementById("profile-view").classList.add("active");
      const rank = members.findIndex((m) => m.id === member.id) + 1;

      document.getElementById("profile-name").textContent = member.name;
      document.getElementById("profile-meta").textContent = `Joined ${formatDate(member.created_at)}`;
      document.getElementById("profile-rank").textContent = `Rank #${rank}`;
      document.getElementById("profile-age").textContent = `${member.age} years`;
      document.getElementById("profile-location").textContent = member.location ? `Location: ${member.location}` : "";
      document.getElementById("profile-bio").textContent = member.bio || "";

      const url = new URL(window.location);
      url.searchParams.set("member", member.id);
      history.pushState({ member: member.id }, "", url);

      document.getElementById("download-card").onclick = () => downloadCard(member, rank);
      document.getElementById("share-profile").onclick = () => shareProfile(member, url.toString());
    }

    function closeProfile() {
      document.getElementById("profile-view").classList.remove("active");
      document.getElementById("home-view").classList.add("active");
      const url = new URL(window.location);
      url.searchParams.delete("member");
      history.pushState({}, "", url);
    }

    function downloadCard(member, rank) {
      const canvas = document.getElementById("card-canvas");
      const ctx = canvas.getContext("2d");

      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "#ffffff";
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      ctx.fillStyle = "#0b5fff";
      ctx.fillRect(40, 40, canvas.width - 80, canvas.height - 80);

      ctx.fillStyle = "#ffffff";
      ctx.font = "600 44px 'Space Grotesk', sans-serif";
      ctx.fillText("Aliveboard", 80, 120);

      ctx.font = "600 32px 'Space Grotesk', sans-serif";
      ctx.fillText(`${member.name}`, 80, 200);
      ctx.font = "400 22px 'Space Grotesk', sans-serif";
      ctx.fillText(`Rank #${rank}`, 80, 250);
      ctx.fillText(`${member.age} years old`, 80, 290);
      if (member.location) ctx.fillText(member.location, 80, 330);

      ctx.font = "400 18px 'Space Grotesk', sans-serif";
      ctx.fillText("aliveboard.co.uk", 80, 400);

      const link = document.createElement("a");
      link.download = `aliveboard-${member.name}.png`;
      link.href = canvas.toDataURL("image/png");
      link.click();
    }

    async function shareProfile(member, url) {
      if (navigator.share) {
        try {
          await navigator.share({
            title: `Aliveboard: ${member.name}`,
            text: `See ${member.name}'s rank on Aliveboard.`,
            url
          });
          return;
        } catch (error) {
          console.warn(error);
        }
      }
      await navigator.clipboard.writeText(url);
      alert("Profile link copied to clipboard");
    }

    document.getElementById("signup").addEventListener("submit", async (event) => {
      event.preventDefault();
      const name = document.getElementById("name").value.trim();
      const age = Number(document.getElementById("age").value);
      const location = document.getElementById("location").value.trim();
      const bio = document.getElementById("bio").value.trim();
      if (!name || !Number.isFinite(age)) return;

      const { error } = await supabase.from("members").insert({ name, age, location, bio });
      if (error) {
        document.getElementById("load-error").textContent = "Could not submit your entry. Please try again.";
        return;
      }

      document.getElementById("name").value = "";
      document.getElementById("age").value = "";
      document.getElementById("location").value = "";
      document.getElementById("bio").value = "";
      await fetchMembers();
    });

    document.getElementById("back-home").addEventListener("click", closeProfile);
    document.getElementById("home-link").addEventListener("click", closeProfile);

    window.addEventListener("popstate", () => {
      const params = new URLSearchParams(window.location.search);
      const id = params.get("member");
      if (!id) {
        closeProfile();
        return;
      }
      const member = members.find((m) => m.id === id);
      if (member) openProfile(member);
    });

    async function boot() {
      await fetchMembers();
      const params = new URLSearchParams(window.location.search);
      const id = params.get("member");
      if (id) {
        const member = members.find((m) => m.id === id);
        if (member) openProfile(member);
      }
    }

    boot();
  </script>
</body>
</html>
